# agents.md — Codex Operating Manual (Python / HTML Reporting / Plotly)

This repository is developed with Codex in VS Code using a **continuous sprint** workflow that simulates a small software team.

Codex must follow the roles + phase gates below and iterate until the task is complete.

---

## Permanent Instructions

- Only edit files using the standard file edit tool, not with commands.
- Work autonomously in a loop (roles + gates) until the task is declared done.
- Make changes in small, coherent increments. Avoid large, sweeping refactors unless required.
- Do not introduce secrets (API keys, tokens, credentials) into the repo. If required, ask for them and use local placeholders.
- Prefer deterministic, reproducible work: keep decisions and progress documented in the task file (see Task Files section).
- Prefer offline-friendly output: the HTML report should render without external CDNs unless explicitly required.

---

## Tech Stack Standards

### Language
- Python 3.x

### Report Output
- A single self-contained **HTML report** (preferred), generated by Python.
- Use simple, dependency-light HTML templating:
  - Prefer Python string templates or `jinja2` (only if already in the repo or explicitly allowed).

### Charting
- Plotly (interactive charts)
- Default embedding approach:
  - Use Plotly’s HTML export utilities to embed charts into the report.
  - Prefer **inline / self-contained** Plotly output when feasible.

### Data Handling
- Prefer `pandas` for tabular manipulation when appropriate.
- Prefer explicit typed-ish structures (dataclasses / clear dict schemas) over loosely structured nested maps.

### Testing
- `pytest` is the default (if present).
- Priority: unit tests for the report generator and chart builder functions.
- Snapshot-style checks are acceptable (e.g., “HTML contains expected div ids / titles / traces”), but avoid brittle full-HTML exact matches unless stabilized.

---

## Operating Principles

- **Phase gates are mandatory.** Do not proceed to the next role until the current gate passes.
- **Evidence over vibes.** Each gate requires concrete proof (tests created, tests failing/passing, lint checks, sample output generated, checklist updates).
- **No guessing about requirements.** If report contents/sections/charts are ambiguous, document assumptions in the task file and proceed with a reasonable default.
- **Keep architecture lightweight and just-in-time.** Decide only what is necessary to implement the next tactical slice correctly.
- **Never silently change constraints.** If requirements conflict, document it and propose options.

---

## Task Files (Required)

For every user task, create/update exactly one task file:

- Location: `docs/tasks/`
- Filename: `YYYY-MM-DD_<short-slug>.md`
- Purpose:
  - Contains the Task Contract, plan, architecture notes, test plan, checklist, and progress log.
  - Acts as the single source of truth during iterations.

### Task File Template (must be used)

- **Task Contract**
  - Goal
  - Acceptance Criteria (clear, measurable)
  - Non-Goals
  - Assumptions / Open Questions (minimize)
- **Strategic Plan** (high-level phases)
- **Tactical Plan** (finely diced tasks, checkbox list)
- **Architecture Notes** (just-in-time decisions)
- **Test Plan**
  - Automated tests (what/where)
  - Manual verification script (how to open/view report)
- **Progress Log** (append-only; short entries per iteration)
- **Final Summary** (only when done)

---

## Roles & Phase Gates (Continuous Sprint Loop)

Codex must execute roles in order and loop as needed:

0) Intake → 1) Planner → 2) Architect → 3) QA (tests-first) → 4) Developer → 5) Build/Verify → 6) QA (re-run/expand) → 7) Reviewer → 8) Planner (close-out/next)

If a gate fails, return to the appropriate earlier role and continue iterating.

---

## Phase 0 — Intake (Pre-Planner)

### Responsibilities
- Restate the user request in your own words.
- Extract/define Acceptance Criteria (measurable).
- Identify unknowns that block implementation.

### Gate: PASS if all are true
- Acceptance Criteria are present and testable/verifiable.
- Any blocking unknowns are either resolved via reasonable assumption (documented) or explicitly requested from the user.

---

## Role 1 — Planner (Strategic → Tactical)

### Responsibilities
- Create/update the task file under `docs/tasks/`.
- Produce:
  - Strategic plan: phases/milestones
  - Tactical plan: **small, implementable tasks** (finely diced)
- Keep a checklist that will be checked off as work completes.

### Gate: PASS if all are true
- A task file exists and includes Task Contract + both plans.
- Tactical tasks are small enough to implement and verify in isolation.
- Dependencies between tasks are explicit and ordered.

---

## Role 2 — Architect (Just-in-Time)

### Responsibilities
Define only the architecture needed for the next tactical slice, including:

- Module/package placement
- Key public API (the report generator function signature)
- Data contract:
  - Inputs (dataframes? dicts? file paths? config objects?)
  - Outputs (HTML string? HTML file path? both?)
- Chart assembly strategy:
  - Single “chart builder” functions that return Plotly `Figure`
  - A report compositor that embeds multiple figures + narrative sections
- Error handling strategy:
  - Validate inputs early
  - Produce actionable exceptions/messages
  - Never generate partially broken HTML silently

Record decisions in the task file (Architecture Notes).

### Gate: PASS if all are true
- Architectural choices are sufficient to avoid rework for the next slice.
- The public API is clear and stable (function name, args, return type, side effects).

---

## Role 3 — QA (Tests-First + Verification Plan)

### Responsibilities
- Write/extend automated tests for the next tactical slice **before** implementation.
- Focus on what is realistically testable:
  - Chart builders produce `plotly.graph_objects.Figure`
  - Report generator returns HTML and/or writes a file
  - HTML includes expected sections, titles, and chart placeholders
  - Input validation and error paths
- Add a manual verification checklist:
  - “Open report.html in a browser”
  - Check interactions (hover, zoom, legend toggle)
  - Confirm sections render without console errors (optional)

Ensure tests fail for the right reasons (red phase).

### Gate: PASS if all are true
- New/updated tests exist for the slice.
- Tests currently fail (or clearly demonstrate missing functionality).
- Manual verification checklist is added.

---

## Role 4 — Developer (Implementation)

### Responsibilities
- Implement the tactical slice following the architecture notes.
- Keep changes minimal and coherent.
- Ensure the report is readable:
  - Clear headings and sections
  - Basic styling (minimal CSS is fine)
  - Charts embedded with consistent sizing and responsive behavior where possible
- Update task checklist items as they become complete (but do not mark done until QA gate passes).

### Gate: PASS if all are true
- Implementation matches the plan and architecture notes.
- No placeholder TODOs for core logic.
- Code runs in principle (no missing symbols, obvious wiring gaps).

---

## Role 5 — Build/Verify (Mechanical Gate)

### Responsibilities
- Run the standard verification steps available in the environment.
- Preferred commands (if runnable):
  - `python -m pytest`
  - `python -m ruff check .` (if used)
  - `python -m mypy .` (if used)
- Generate a sample report artifact if part of acceptance criteria (e.g., `report.html`).

If you cannot run commands in this environment, instruct the user exactly what to run and what output to paste.

### Gate: PASS if all are true
- Tests succeed **and**
- A sample HTML report is generated and opens in a browser without obvious issues
  **or**
- If blocked, a clear request for output is made and the next action depends on that output.

---

## Role 6 — QA (Re-run + Expand)

### Responsibilities
- Re-run tests after implementation.
- Add missing tests discovered during coding.
- Ensure edge cases are covered:
  - empty data
  - missing columns / wrong schema
  - NaNs / invalid types
  - huge datasets (basic performance sanity)
  - filesystem write permissions (if writing files)
- Confirm interactive Plotly behavior remains intact (manual checklist).

### Gate: PASS if all are true
- All relevant automated tests pass.
- Coverage is reasonable for critical logic.
- Manual verification checklist is ready and accurate.

---

## Role 7 — Reviewer (Quality, Consistency, Risks)

### Responsibilities
Perform a code review for:
- correctness vs acceptance criteria
- API clarity and stability
- readability and maintainability
- HTML safety (avoid injecting raw unsanitized user strings into HTML)
- chart correctness (labels, titles, axis formatting)
- performance pitfalls (unnecessary copies, huge inline payloads without warning)
- error handling & resilience

Produce a checklist of required changes with severity:
- Blocker / Major / Minor / Nit

If changes are required, route back to the appropriate role:
- Architecture issues → Architect
- Test gaps → QA
- Implementation bugs → Developer

### Gate: PASS if all are true
- Reviewer explicitly approves the slice **or**
- Reviewer produces a blocking checklist and work loops back accordingly (no silent approval).

---

## Role 8 — Planner (Close-out + Next Slice)

### Responsibilities
- Confirm the slice meets Acceptance Criteria with evidence.
- Check off completed tactical items in the task file.
- Update the Progress Log and add a short “What changed” summary.
- Decide and queue the next tactical slice (repeat loop) until the full task is complete.
- Always commit and merge into GitHub after pass.

### Gate: PASS if all are true
- Checklist reflects reality (only verified items are checked).
- Acceptance Criteria are met (or documented as pending).
- Next actions are clearly stated.

---

## Project Conventions

### Package / Layering (recommended)
- `src/`
  - `reporting/` — HTML composition, templates, CSS, layout helpers
  - `charts/` — Plotly chart builder functions
  - `data/` — loaders, schema validation, transformations
  - `models/` — dataclasses / typed structures
  - `utils/` — helpers
- `tests/` — pytest tests

### HTML + Styling Guidance
- Prefer simple semantic HTML.
- Use minimal CSS.
- Report should work in a modern browser with no build step.

### Error Handling
- Use clear exceptions with actionable messages.
- Validate data schemas early.
- Never crash due to a single malformed row if graceful degradation is possible.

---

## Definition of Done (Global)

- All Acceptance Criteria satisfied.
- All tests pass.
- Reviewer approved.
- HTML report renders with interactive Plotly charts.

---

## Communication Format (Status Updates)

- When reporting progress, always include:
- Current role + gate status (PASS/FAIL)
- What changed (files touched)
- What’s next (next role / next slice)
- If blocked: exact request (command + output needed)

---

## Non-Negotiables

- Do not skip gates.
- Do not mark checklist items complete without evidence.
- Do not introduce secrets.
- Do not embed external CDNs unless explicitly requested (prefer self-contained HTML output).
- Do not use commands to edit files; use the standard file edit tool only.